function miniModalBox(e) {
    e.each(function () {
        $("body").append(this);

        var modal = $(this);
        var modalId = this.id;

        $("a[href=\"#" + modalId + "\"],button[data-modal=\"#" + modalId + "\"]").off().on("click", function (event) {
            event.preventDefault();
            var pr = window.innerWidth - $(window).width();

            $("html").css({
                "overflow": "hidden",
                "padding-right": pr
            });
            modal.stop().fadeIn(300, function () {
                modal.addClass("active");

                modal.find("button:not(.disabled),a:not(.disabled)").eq(0).trigger("focus");

            })
        });


        if (modal.hasClass("is-show")) {
            var show = true;
            if (modal.data("expiration")) {
                if (typeof jQuery.cookie == "undefined") {
                    jQuery.cookie = function (key, value, options) {
                        if (arguments.length > 1 && (value === null || typeof value !== "object")) {
                            options = jQuery.extend({}, options);
                            if (value === null) {
                                options.expires = -1;
                            }
                            if (typeof options.expires === 'number') {
                                var days = options.expires,
                                    t = options.expires = new Date();
                                t.setDate(t.getDate() + days);
                            }
                            return (document.cookie = [
                                encodeURIComponent(key), '=',
                                options.raw ? String(value) : encodeURIComponent(String(value)),
                                options.expires ? '; expires=' + options.expires.toUTCString() : '', 
                                options.path ? '; path=' + options.path : '',
                                options.domain ? '; domain=' + options.domain : '',
                                options.secure ? '; secure' : ''
                            ].join(''));
                        }
                        options = value || {};
                        var result, decode = options.raw ? function (s) {
                            return s;
                        } : decodeURIComponent;
                        return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? decode(result[1]) : null;
                    };
                }
                if (jQuery.cookie(modalId+"_"+(modal.data("version") || 1))) {
                    show = false; 
                }
            }
            if(show){
                var pr = window.innerWidth - $(window).width();
                setTimeout(function(){
                    $("html").css({
                        "overflow": "hidden",
                        "padding-right": pr
                    });
                    modal.stop().fadeIn(300, function () {
                        modal.addClass("active");
                        modal.find("button:not(.disabled),a:not(.disabled)").eq(0).trigger("focus");
                    });
                },modal.data("popupdelay")*1000 || 1000);
            }

        };

        modal.find(".modalbox-close,.modalbox-secondary").on("click", function () {
            modal.stop().fadeOut(300, function () {
                modal.removeClass("active");
                $("html").css({
                    "overflow": "",
                    "padding-right": ''
                });
                if (modal.hasClass("is-show") && modal.data("expiration")) {
                    jQuery.cookie(modalId+"_"+(modal.data("version") || 1), true, {
                        expires: modal.data("expiration"),
                        path: '/'
                    });
                };
            });
        })

        if(!modal.find(".focus-before").length){
            modal.find(".modalbox-dialog").before('<span tabindex="0" class="focus-before"></span>');
        }
        if(!modal.find(".focus-after").length){
            modal.find(".modalbox-dialog").after('<span tabindex="0" class="focus-after"></span>');
        }
        modal.find(".focus-before").off().on("focus",function(){
            modal.find("button:not(.disabled),a:not(.disabled)").eq(modal.find("button:not(.disabled),a:not(.disabled)").length-1).trigger("focus"); 
        })
        modal.find(".focus-after").off().on("focus",function(){
            modal.find("button:not(.disabled),a:not(.disabled)").eq(0).trigger("focus"); 
        })
        modal.off().on("keydown",function(event){
            if((event.key && event.key =="Escape") || ( event.keyCode && event.keyCode==27)){   
                modal.find(".modalbox-close").trigger("click");
            } 
        });

    })
}

$(function () {
    if (typeof DNNapplyTypography == "undefined") {
        miniModalBox($(".modalbox"));
    }
})